# Update and get useful packages
$ sudo yum update
$ sudo yum install epel-release
$ sudo yum install krb5-workstation krb5-libs krb5-auth-dialog gcc gcc-c++ java-1.8.0-openjdk python-devel python-pip
$ sudo yum install cmake3 perl-core libtemplate-perl zlib-devel openssl-devel libssh2-devel libmicrohttpd-devel curl-devel gtest-devel
$ sudo yum group install 'Development Tools'

# Add the following to /etc/environment to set locale:
LC_ALL="en_US.UTF-8"
LC_CTYPE="en_US.UTF-8"
LANGUAGE="en_US.UTF-8"

# Install tight-vnc server and start
$ yum -y install tigervnc-server xorg-x11-fonts-Type1
$ sudo vncpasswd
$ vncserver -localhost -nolisten tcp -geometry 1280x1024 -rfbport 5900

# Install ROOT in /home/daq/software/root
$ cd /home/daq/software
$ wget https://root.cern.ch/download/root_v6.16.00.Linux-centos7-x86_64-gcc4.8.tar.gz
$ tar xzvf root_v6.16.00.Linux-centos7-x86_64-gcc4.8.tar.gz

# Add ROOT to paths, by adding the following to .bash_profile:
export ROOTSYS=/home/daq/software/root
export PATH=$ROOTSYS/bin:$PATH
export LD_LIBRARY_PATH=$ROOTSYS/lib:$LD_LIBRARY_PATH
export DYLD_LIBRARY_PATH=$ROOTSYS/lib:$DYLD_LIBRARY_PATH

# Install BOOST in standard location
$ wget https://dl.bintray.com/boostorg/release/1.68.0/source/boost_1_68_0.tar.gz
$ tar -xzf boost_1_*
$ cd boost_1_*
$ sudo ./bootstrap.sh
$ sudo ./b2 install --with=all

# Install Grafana
$ sudo yum install https://dl.grafana.com/oss/release/grafana-5.4.2-1.x86_64.rpm
$ sudo service grafana-server start

# Open required ports on the firewall
$ sudo firewall-cmd --permanent --add-port=56015/udp  # Optical CLB Packets
$ sudo firewall-cmd --permanent --add-port=56017/udp  # Monitoring CLB Packets
$ sudo firewall-cmd --permanent --add-port=5601/tcp   # Kibana
$ sudo firewall-cmd --permanent --add-port=5900/tcp   # vncserver
$ sudo firewall-cmd --permanent --add-port=9200/tcp   # Elasticsearch
$ sudo firewall-cmd --permanent --add-port=3000/tcp   # Grafana
$ sudo firewall-cmd --reload

# Install and configure the Elastic Stack
# Mainly taken from https://computingforgeeks.com/how-to-install-elk-stack-on-centos-fedora/
# Can't seem to get 7.1 working at the moment, for now use 6.8

# In /etc/yum.repos.d/elasticsearch.repo set the following:
[elasticsearch-6.x]
name=Elasticsearch repository for 6.x packages
baseurl=https://artifacts.elastic.co/packages/6.x/yum
gpgcheck=1
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled=1
autorefresh=1
type=rpm-md

# Install the stack using yum
$ sudo rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch
$ sudo yum clean all
$ sudo yum makecache
$ sudo yum -y install elasticsearch kibana metricbeat heartbeat-elastic

# Create the 
$ cd /usr/share/elasticsearch
$ bin/elasticsearch-certutil cert -out /etc/elasticsearch/elastic-certificates.p12 -pass ""

# In /etc/elasticsearch/elasticsearch.yml set the following:
network.host: 0.0.0.0
network.publish_host: 192.167.1.130
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate
xpack.security.transport.ssl.keystore.path: elastic-certificates.p12
xpack.security.transport.ssl.truststore.path: elastic-certificates.p12

# Start the elasticsearch server and check it is running
$ sudo systemctl enable --now elasticsearch.service 
$ curl http://127.0.0.1:9200 



$ sudo systemctl enable --now elasticsearch.service 

PUT daqlog
{
  "mappings": {
    "standard": {
      "properties": {
        "@timestamp": {
          "type": "date"
        },
        "process": {
          "type": "text"
        },
        "pid": {
          "type": "integer"
        },
        "severity": {
          "type": "integer"
        },
        "message": {
          "type": "text"
        }
      }
    }
  }
}

PUT daqmon
{
  "mappings": {
    "pommon": {
      "properties": {
        "@timestamp": {
          "type": "date"
        },
        "run_num": {
          "type": "integer"
        },
        "pom_id": {
          "type": "integer"
        },
        "packet_time": {
          "type": "date"
        },
        "temperature": {
          "type": "integer"
        },
        "humidity": {
          "type": "integer"
        },
        "message": {
          "type": "text"
        },
        "hits": {
          "type": "integer"
        }
      }
    }
  }
}

### Alerting (ElastAlert) ###
$ git clone https://github.com/Yelp/elastalert.git
$ sudo pip install "setuptools>=11.3"
$ sudo python setup.py install
$ elastalert-create-index
- need to add "timestamp_type: unix_ms" to all rules

### Grafana ###
$ sudo yum install https://dl.grafana.com/oss/release/grafana-5.4.2-1.x86_64.rpm
$ sudo service grafana-server start

- Need to add -DBOOST_ERROR_CODE_HEADER_ONLY to cxxflags due to boost_system error